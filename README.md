# **БАЗА** по Базам

---

## 1. Понятие СУБД. Функции СУБД. Отличие от хранения в таблицах

**СУБД (Система управления базами данных)** — это программное обеспечение для создания, управления, модификации и защиты БД.

### Основные функции СУБД:
- Хранение, добавление, изменение, удаление данных
- Управление транзакциями (атомарность, согласованность, изолированность, долговечность — ACID)
- Обеспечение целостности данных (ограничения, ключи)
- Защита и управление доступом (роли, права)
- Резервное копирование и восстановление
- Механизмы журналирования (лог WAL в PostgreSQL)

**Отличия от хранения в таблицах (например, Excel):**
| Характеристика      | СУБД (PostgreSQL)            | Таблицы (Excel, Google Sheets) |
|---------------------|------------------------------|-------------------------------|
| Целостность данных  | Да (ограничения, ключи)      | Нет                           |
| Одновременная работа| Да (многопользовательская)    | Ограничено                    |
| Масштабируемость    | Высокая                       | Низкая                        |
| Безопасность        | Гибкое управление доступом    | Простое или отсутствует       |
| Язык запросов       | SQL                           | Нет                           |

---

## 2. Трехуровневая архитектура ANSI-SPARC

Позволяет отделить логику представления данных от их физического хранения:

1. **Внешний уровень** — представление данных для пользователя (view).
2. **Концептуальный уровень** — логическая модель всех данных, описание сущностей и связей.
3. **Внутренний уровень** — физическая реализация (файлы, индексы, способы хранения).

**Преимущества**:
- Независимость данных
- Гибкость при изменениях на любом уровне

---

## 3. Языки БД. DDL, DML

**SQL** — язык взаимодействия с БД. Делится на несколько категорий:

- **DDL (Data Definition Language)** — определение структуры БД:
  - `CREATE`, `ALTER`, `DROP`, `TRUNCATE`

- **DML (Data Manipulation Language)** — управление данными:
  - `SELECT`, `INSERT`, `UPDATE`, `DELETE`

- Также выделяют:
  - **DCL (Data Control Language)** — управление доступом: `GRANT`, `REVOKE`
  - **TCL (Transaction Control Language)** — управление транзакциями: `BEGIN`, `COMMIT`, `ROLLBACK`

---

## 4. Понятие ключа

**Ключ** — набор атрибутов, однозначно идентифицирующих строку в таблице.

- **Потенциальный ключ** — любой минимальный уникальный набор полей.
- **Первичный ключ (PRIMARY KEY)** — выбранный потенциальный ключ.
- **Альтернативный ключ** — потенциальный ключ, не ставший первичным.
- **Составной ключ** — ключ из нескольких атрибутов.
- **Внешний ключ (FOREIGN KEY)** — ссылка на первичный ключ другой таблицы, обеспечивает ссылочную целостность.

---

## 5. «Сущность – связь». ER-модель

**Сущность** — объект предметной области (например, `Student`).  
**Связь (relationship)** — логическая ассоциация между сущностями (например, `enrolled_in`).

### Типы связей:
- **1:1** — один к одному (например, `Person` — `Passport`)
- **1:N** — один ко многим (например, `Department` — `Employee`)
- **M:N** — многие ко многим (например, `Student` — `Course`)

### ER-модели:
- **Crow's Foot (вороний клюв)** — обозначает кратности и обязательность
- **IDEF1X** — фокусируется на ключах и отношениях, применяется в проектировании БД

---

## 6. Нормализация. Цель и аномалии

**Нормализация** — процесс приведения структуры таблиц к форме, устраняющей избыточность и аномалии.

### Цель:
- Минимизировать избыточность данных
- Устранить **аномалии вставки, удаления, обновления**

**Пример аномалий**:
- Вставка невозможна без дополнительной информации
- Удаление строки удаляет важные данные
- Обновление требует изменить значение в нескольких местах

---

## 7. Функциональные зависимости и 1НФ, 2НФ

### Функциональная зависимость:
`A → B`, если по значению A однозначно определяется B.

### Нормальные формы:
- **1НФ** — все атрибуты атомарны (нет повторяющихся или вложенных полей)
- **2НФ** — 1НФ + каждый неключевой атрибут полностью функционально зависит от первичного ключа (не только от части составного ключа)

**Пример нарушения 2НФ**: если `StudentID, CourseID` → `Grade`, но `StudentName` зависит только от `StudentID`

---

## 8. 3НФ, OLTP и OLAP, достоинства и недостатки нормализации

### 3НФ (Третья нормальная форма):
- Таблица в 2НФ
- Нет **транзитивных зависимостей** между неключевыми атрибутами:
  - если `A → B` и `B → C`, то `A → C` — плохо
- **Транзитивная зависимость** возникает, когда неключевой атрибут зависит не от первичного ключа, а от другого неключевого атрибута.

### OLTP (Online Transaction Processing): 
Технология обработки транзакций в базах данных, ориентированная на быструю и эффективную работу с большим количеством коротких операций в реальном времени.
- Системы для обработки повседневных транзакций
- Много операций INSERT, UPDATE, DELETE
- Требует высокой нормализации

### OLAP (Online Analytical Processing):
Технология обработки данных, предназначенная для сложного анализа больших объемов информации, построения отчетов и бизнес-аналитики.
- Анализ больших объемов данных
- Много операций SELECT, агрегирования
- Использует денормализованные схемы (звезда, снежинка)

### Достоинства нормализации:
- Минимизация избыточности
- Устранение аномалий
- Повышение целостности данных

### Недостатки:
- Сложность запросов (много JOIN'ов)
- Потеря производительности в аналитике


## 9. Простые запросы. Оператор SELECT. Синтаксис. Вычисляемые столбцы. Именование столбца

**SELECT** — основной оператор для извлечения данных из таблиц.

### Синтаксис:
```sql
SELECT [столбцы или выражения]
FROM имя_таблицы;
````

### Пример:

```sql
SELECT name, age FROM students;
```

### Вычисляемые столбцы:

Можно выполнять арифметические операции и использовать функции:

```sql
SELECT name, age + 1 AS age_next_year FROM students;
```

### Именование столбцов:

* `AS` позволяет задать читаемое имя столбца
* Альтернативно можно просто указать имя без `AS`

```sql
SELECT name || ' ' || surname AS full_name FROM students;
```

---

## 10. Выборка строк. Конструкция WHERE

**WHERE** — фильтрация строк по условию.

### Примеры:

```sql
SELECT * FROM students WHERE age > 20;
SELECT * FROM students WHERE name = 'Alice';
SELECT * FROM students WHERE age BETWEEN 18 AND 22;
SELECT * FROM students WHERE name LIKE 'A%';  -- имена на А
SELECT * FROM students WHERE email IS NULL;
```

> ⚠ `=` — для точного сравнения, `LIKE` — для шаблонов, `IS NULL` — проверка на NULL

---

## 11. Сортировка результатов. Конструкция ORDER BY

**ORDER BY** — задаёт порядок вывода строк.

### Примеры:

```sql
SELECT * FROM students ORDER BY age;             -- по возрастанию
SELECT * FROM students ORDER BY age DESC;        -- по убыванию
SELECT * FROM students ORDER BY age, name;       -- сначала по возрасту, затем по имени
```

---

## 12. Использование агрегирующих функций языка SQL

Агрегатные функции обрабатывают группы строк и возвращают одно значение.

| Функция   | Назначение       |
| --------- | ---------------- |
| `COUNT()` | Количество строк |
| `SUM()`   | Сумма значений   |
| `AVG()`   | Среднее значение |
| `MAX()`   | Максимум         |
| `MIN()`   | Минимум          |

COUNT(*) считает все строки, с учетом NULL.

COUNT(column) считает только не-NULL значения в указаном столбце.

Все остальные NULL игнорируют. Если все значения NULL, то результат NULL.

### Примеры:

```sql
SELECT COUNT(*) FROM students;
SELECT AVG(age) FROM students WHERE age IS NOT NULL;
SELECT MAX(age), MIN(age) FROM students;
```

---

## 13. Группирование результатов. GROUP BY и HAVING

**GROUP BY** — группировка строк по значению столбца.
**HAVING** — фильтрация групп (как WHERE, но после группировки).

### Пример:

```sql
SELECT age, COUNT(*) AS num_students
FROM students
GROUP BY age;
```

### С использованием HAVING:

```sql
SELECT age, COUNT(*) AS num_students
FROM students
GROUP BY age
HAVING COUNT(*) > 3;
```

---

## 14. Подзапросы

Подзапрос — вложенный SELECT, может использоваться:

* В выражении `WHERE`, `FROM`, `SELECT`
* Возвращать скалярное, строчное или табличное значение

### Примеры:

```sql
-- Студенты с максимальным возрастом
SELECT * FROM students
WHERE age = (SELECT MAX(age) FROM students);

-- Подзапрос в FROM (inline view)
SELECT avg_age FROM (
    SELECT AVG(age) AS avg_age FROM students
) AS sub;
```

---

## 15. Многотабличные запросы. Псевдонимы таблиц

Псевдонимы таблиц делают запросы короче и удобнее.

### Пример:

```sql
SELECT s.name, d.name
FROM students AS s
JOIN departments AS d ON s.department_id = d.id;
```

---

## 16. Многотабличные запросы. Выполнение соединений (JOIN)

В PostgreSQL есть несколько видов соединений:

| Вид JOIN     | Назначение                            |
| ------------ | ------------------------------------- |
| `INNER JOIN` | Только совпадающие строки             |
| `LEFT JOIN`  | Все из левой, + совпадающие из правой |
| `RIGHT JOIN` | Все из правой, + совпадающие из левой |
| `FULL JOIN`  | Все строки обеих таблиц               |
| `CROSS JOIN` | Декартово произведение                |

### Пример INNER JOIN:

```sql
SELECT s.name, d.name AS department
FROM students s
JOIN departments d ON s.department_id = d.id;
```

---

## 17. Комбинирование результирующих таблиц. UNION, INTERSECT, EXCEPT

Работают с SELECT-запросами с одинаковым числом и типом столбцов.

| Оператор    | Описание                             |
| ----------- | ------------------------------------ |
| `UNION`     | Объединение без повторов             |
| `UNION ALL` | Объединение с повторами              |
| `INTERSECT` | Общие строки                         |
| `EXCEPT`    | Разность (в первом, но не во втором) |

### Пример:

```sql
SELECT name FROM students
UNION
SELECT name FROM teachers;
```

---

## 18. Изменение содержимого БД. Операция UPDATE

**UPDATE** — изменяет существующие строки.

### Синтаксис:

```sql
UPDATE таблица
SET столбец = выражение [, ...]
WHERE условие;
```

### Пример:

```sql
UPDATE students
SET age = age + 1
WHERE name = 'Alice';
```

> ⚠ Без `WHERE` изменятся все строки!

---

## 19. Изменение содержимого БД. Операции INSERT, DELETE

### INSERT — добавление новых строк:

```sql
INSERT INTO students (name, age) VALUES ('Bob', 20);
```

* Можно добавить несколько строк:

```sql
INSERT INTO students (name, age)
VALUES ('Tom', 19), ('Lisa', 22);
```

### DELETE — удаление строк:

```sql
DELETE FROM students WHERE age < 18;
```

> ⚠ Без `WHERE` удалятся **все строки**:

```sql
DELETE FROM students;
```
